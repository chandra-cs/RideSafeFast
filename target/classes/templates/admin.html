<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Cab Booking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-taxi"></i> Cab Booking System</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/register">Register</a>
                <a class="nav-link" href="/book">Book Cab</a>
                <a class="nav-link" href="/bookings">Bookings</a>
                <a class="nav-link" href="/customers">Customers</a>
                <a class="nav-link active" href="/admin">Admin</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-danger text-white">
                        <h3><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h3>
                    </div>
                    <div class="card-body">
                        <div th:if="${error}" class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
                        </div>
                        
                        <!-- Dashboard Statistics -->
                        <div class="row mb-4" th:if="${dashboard}">
                            <div class="col-md-3 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <h4 th:text="${dashboard.totalCustomers}">0</h4>
                                        <p class="mb-0">Total Customers</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                        <h4 th:text="${dashboard.totalBookings}">0</h4>
                                        <p class="mb-0">Total Bookings</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-clock fa-2x mb-2"></i>
                                        <h4 th:text="${dashboard.pendingBookings}">0</h4>
                                        <p class="mb-0">Pending Bookings</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                        <h4>$<span th:text="${dashboard.totalRevenue}">0</span></h4>
                                        <p class="mb-0">Total Revenue</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                                <div class="btn-group" role="group">
                                    <a href="/customers" class="btn btn-outline-primary">
                                        <i class="fas fa-users"></i> Manage Customers
                                    </a>
                                    <a href="/bookings" class="btn btn-outline-success">
                                        <i class="fas fa-list"></i> View All Bookings
                                    </a>
                                    <a href="/register" class="btn btn-outline-info">
                                        <i class="fas fa-user-plus"></i> Add Customer
                                    </a>
                                    <button class="btn btn-outline-warning" onclick="refreshDashboard()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Bookings -->
                        <div class="row">
                            <div class="col-md-12">
                                <h5><i class="fas fa-history"></i> Recent Bookings</h5>
                                <div th:if="${bookings.empty}" class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No recent bookings found.
                                </div>
                                
                                <div th:if="${!bookings.empty}" class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Customer</th>
                                                <th>Route</th>
                                                <th>Cab Type</th>
                                                <th>Status</th>
                                                <th>Fare</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="booking, iterStat : ${bookings}" th:if="${iterStat.index < 10}">
                                                <td th:text="${booking.id}"></td>
                                                <td th:text="${booking.customer?.name ?: 'N/A'}"></td>
                                                <td>
                                                    <small th:text="${booking.pickupLocation + ' â†’ ' + booking.destination}"></small>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary" th:text="${booking.cabType}"></span>
                                                </td>
                                                <td>
                                                    <span th:class="'badge ' + 
                                                        (${booking.status.name()} == 'PENDING' ? 'bg-warning' : 
                                                         ${booking.status.name()} == 'CONFIRMED' ? 'bg-success' : 
                                                         ${booking.status.name()} == 'COMPLETED' ? 'bg-primary' : 
                                                         ${booking.status.name()} == 'CANCELLED' ? 'bg-danger' : 'bg-secondary')" 
                                                          th:text="${booking.status}"></span>
                                                </td>
                                                <td th:text="${booking.totalFare ? '$' + booking.totalFare : 'TBD'}"></td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                                th:if="${booking.status.name()} == 'PENDING'"
                                                                th:onclick="'updateStatus(' + ${booking.id} + ', \'CONFIRMED\')'">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                                th:if="${booking.status.name()} == 'CONFIRMED'"
                                                                th:onclick="'updateStatus(' + ${booking.id} + ', \'COMPLETED\')'">
                                                            <i class="fas fa-flag-checkered"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                                th:if="${booking.status.name()} != 'CANCELLED' and ${booking.status.name()} != 'COMPLETED'"
                                                                th:onclick="'updateStatus(' + ${booking.id} + ', \'CANCELLED\')'">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Status Distribution Chart -->
                        <div class="row mt-4" th:if="${dashboard}">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-pie"></i> Booking Status Distribution</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-warning" role="progressbar" 
                                                 th:style="'width: ' + (${dashboard.totalBookings} > 0 ? (${dashboard.pendingBookings} / ${dashboard.totalBookings} * 100) : 0) + '%'">
                                                Pending (<span th:text="${dashboard.pendingBookings}"></span>)
                                            </div>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 th:style="'width: ' + (${dashboard.totalBookings} > 0 ? (${dashboard.confirmedBookings ?: 0} / ${dashboard.totalBookings} * 100) : 0) + '%'">
                                                Confirmed (<span th:text="${dashboard.confirmedBookings ?: 0}"></span>)
                                            </div>
                                        </div>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-primary" role="progressbar" 
                                                 th:style="'width: ' + (${dashboard.totalBookings} > 0 ? (${dashboard.completedBookings ?: 0} / ${dashboard.totalBookings} * 100) : 0) + '%'">
                                                Completed (<span th:text="${dashboard.completedBookings ?: 0}"></span>)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-bar"></i> System Health</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Active Customers</span>
                                            <span class="badge bg-success" th:text="${dashboard.totalCustomers}">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Today's Bookings</span>
                                            <span class="badge bg-info" th:text="${dashboard.todayBookings ?: 0}">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>System Status</span>
                                            <span class="badge bg-success">Online</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateStatus(bookingId, status) {
            if (confirm(`Are you sure you want to ${status.toLowerCase()} this booking?`)) {
                fetch(`/api/admin/bookings/${bookingId}/status?status=${status}`, {
                    method: 'PUT'
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error updating booking status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating booking status');
                });
            }
        }
        
        function refreshDashboard() {
            location.reload();
        }
        
        // Auto-refresh dashboard every 30 seconds
        setInterval(function() {
            // Refresh dashboard data via AJAX to avoid full page reload
            fetch('/api/admin/dashboard')
                .then(response => response.json())
                .then(data => {
                    // Update dashboard stats without full page reload
                    console.log('Dashboard refreshed');
                })
                .catch(error => console.log('Auto-refresh failed:', error));
        }, 30000);
    </script>
</body>
</html>